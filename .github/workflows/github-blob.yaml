name: Upload to Azure Blob Storage

on: 
    push:
        branches: ["main"]

env:
  APP_NAME: flask-app
  IMAGE_TAG: ${{ github.repository_id }}

permissions:
    id-token: write
    contents: read

jobs:
    upload:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            # - name: Build Docker Image
            #   run: |
            #     docker build -t $APP_NAME:$IMAGE_TAG .

            - name: Azure Login (OIDC)
              uses: azure/login@v2
              with:
                client-id: ${{ secrets.AZURE_CLIENT_ID }}
                tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            # - name: Get secrets from Azure Key Vault
            #   run: |
            #     ACR_USERNAME=$(az keyvault secret show \
            #       --vault-name implocker \
            #       --name acr-username \
            #       --query value -o tsv)
            #     ACR_PASSWORD=$(az keyvault secret show \
            #       --vault-name flask-app-locker \
            #       --name acr-password \
            #       --query value -o tsv)
            #     echo "ACR_USERNAME=$ACR_USERNAME" >> $GITHUB_ENV
            #     echo "ACR_PASSWORD=$ACR_PASSWORD" >> $GITHUB_ENV

            - name: Get secrets from GitHub Secrets
              id: get-azure-keyvault-secrets
              uses: copdips/get-azure-keyvault-secrets-action@v1
              with:
                keyvault: flask-app-locker
              
            - name: Login to ACR
              run: |
                az acr login --name $ACR_USERNAME

            # - name: Docker login to ACR
            #   run: |
            #     docker login $ACR_USERNAME.azurecr.io \
            #     -u $ACR_USERNAME \
            #     -p $ACR_PASSWORD

            # - name: Push Docker Image to ACR
            #   run: |
            #     docker tag $APP_NAME:$IMAGE_TAG $ACR_USERNAME.azurecr.io/$APP_NAME:$IMAGE_TAG
            #     docker push $ACR_USERNAME.azurecr.io/$APP_NAME:$IMAGE_TAG 
                
            - name: Build and push Docker image
              run: |
                docker buildx build \
                  --platform linux/amd64 \
                  -t $ACR_LOGIN_SERVER/$APP_NAME:$IMAGE_TAG \
                  --push .

            - name: Deploy to Azure App Service
              uses: azure/webapps-deploy@v3
              with:
                app-name: LibraryManagement
                images: ${{ env.ACR_LOGIN_SERVER }}/${{ env.APP_NAME }}:${{ env.IMAGE_TAG }}

              
            # - name: Upload file to Blob Storage
            #   run: |
            #     echo "Developed and Automated by: Kinshuk Chauhan" > document.txt
            #     az storage blob upload \
            #       --account-name $STORAGE_ACCOUNT_NAME \
            #       --container-name $BLOB_CONTAINER_NAME \
            #       --file document.txt \
            #       --name document-$(date +%s).txt \
            #       --auth-mode login
